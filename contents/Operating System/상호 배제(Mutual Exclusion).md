# 상호 배제(Mutex: Mutual Exclusion)
## 생산자-소비자 문제
- 비동기적 프로세스들이 작업 수행을 위해 서로 협동하고, 병행 수행하는 대표적인 예시이다.
- 생산자 프로세스는 소비자 프로세스가 소비하는 정보를 생산한다.
- 상호배제와 동기화를 필요로 한다.

### 생산자-소비자의 공유 버퍼(공유 자원)
- 생산자의 데이터 생산과 소비자의 데이터 소비는 서로 독립적이므로 공유 버퍼를 필요로 한다.
- 생산자와 소비자는 같은 버퍼를 사용하므로 공유 변수에 동시에 접근하는 경우 문제가 발생할 수 있다.
  - 생산자가 이미 채워진 버퍼에 더 채우거나 소비자가 빈 데이터를 꺼낼 때 문제가 발생한다.

#### 유한 버퍼의 구현
- 2개의 논리적 포인터 in과 out을 갖는 queue 순환 배열로 구현한다.
- 순차 리스트 버퍼의 경우 삽입, 삭제시 인덱스와 데이터가 이동하는 오버헤드가 발생하여 비효율적이다.

### 공유 변수 동시 접근 문제
- 공유 변수 조작 부분에 동시에 접근할 시 문제가 발생한다.
#### 공유 변수 동시 접근
- 생산자 프로세스와 소비자 프로세스가 counter 변수에 동시 접근 시 counter에 잘못된 값이 저장될 수 있다.
- 예) counter가 5인 경우

### 경쟁 상태(Race Condition)
- 여러 프로세스가 동시에 공유 데이터에 접근할 때, 접근 순서에 따라 실행 결과가 달라지는 상황을 말한다. 
- 해당 상황을 방지하기 위해서는 병행 프로세스들을 동기화해야 한다.
  - 세마포어(Semaphore)
  - 상호 배제(Mutex)
  - 모니터(Monitor)

## 임계 영역(Cirical Section)
- 다수의 프로세스가 실행 가능한 영역이면서 한 순간에 하나의 프로세스만 실행할 수 있는 영역이다.
- 공유 자원의 독점을 보장하기 위한 코드 영역이다.
- 프로세스가 공유 데이터(임계 자원)에 접근하는 동안 그 프로세스는 임계 영역에 있다고 표현한다. 

### 임계 영역 문제 해결 조건 
1. 상호 배제(Mutex)
   - 한 프로세스가 임계 영역에 있는 경우 다른 프로세스는 진입이 불가능해야 한다.
2. 진행(Progress):
   - 임계 영역에 진입한 프로세스가 없는 상태에서 임계 영역에 진입하려는 여러 프로세스가 있는 경우 선택하여 진입하게 해야한다.
3. 유한 대기(Bounded Waiting)
   - 다른 프로세스의 기아를 방지하기 위해, 임계 영역에 한 번 진입했던 프로세스에게 진입 요청 허가의 제한을 두어 무한정 대기 상태를 막는다.
  
### 임계 영역 문제 해결책의 가정 
- 각 기계어 명령어는 분할할 수 없게 실행한다.
  - 하나의 기계어 명령어를 시작하면 인터럽트의 영향을 받지 않고 해당 명령어를 끝까지 실행한다.
- 각 프로세스가 nonzero speed로 실행한다고 가정한다.
  - nonzero speed: 프로세스가 명령어를 실행하는 도중 멈추는 일이 없다. 
- 프로세스들의 상대적인 속도에 대해서 어떠한 가정을 하지 않는다.

### 임계 영역 문제 해결 방법
- 임계 영역 내 인터럽트를 방지한다.
  - 단일 프로세서 환경에서만 사용할 수 있다.
- 임계 영역에 대한 프로세스 동기화를 진행한다.
  - 한 프로세스가 임계 영역 내에 있을 때 다른 프로세스들은 임계 영역에 진입이 금지된다.
  - 세마포어(Semaphore), 상호배제(Mutex), 모니터(Monitor)가 있다.


## 상호 배제(Mutex)
- 한 순간에 하나의 프로세스만을 사용할 수 있는 공유자원에 대해, 한 프로세스가 공유 자원을 사용하는 동안 다른 프로세스가 그 자원에 접근할 수 없게 차단하는 것을 말한다.
- 상호 배제를 위해서는 프로세스 동기화(synchronization) 또는 락(Lock) 이 필요하다.
  - 순차적으로 재사용이 가능한 자원을 공유하는 프로세스들이 공유자원을 동시에 사용하지 못하게 실행 제어하기 위해 프로세스 동기화가 필요하다. (쓰기 연산)
  - 순차적 재사용은 자원을 한 프로세스가 사용한 다음 이어서 다른 프로세스가 사용이 가능하다.
  - 락(Lock): 자원에 대한 접근 제한을 가젱하기 위한 동기화 매커니즘으로 임계 영역에 진입 시 프로세스는 락을 걸고(취득 불가 상태로 전환), 해당 프로세스는 임계 영역을 벗어날 때 락을 반환(취득 가능 상태로 전환)한다.
- 읽기 연산은 상호배제가 필요하지 않다.
  - 프로세스들이 충돌이 없는 연산을 수행하는 경우 공유 자원에 동시에 접근할 수 있다.
- Key(어떤 객체)를 기반으로 상호배제를 진행한다.

### 상호 배제의 조건
1. 두 개 이상의 프로세스들이 동시에 임계 영역(공유 자원)에 있으면 안된다.
2. 어떤 프로세스도 임계 영역(공유 자원)에 진입하는 것이 무한정 연기되면 안된다.
3. 임계 영역(공유 자원) 안에 있는 프로세스가 다른 프로세스의 임계 영역 진입을 막을 수 있어야 한다.
4. 프로세스들의 상대적인 속도(각 프로세스들의 처리 속도, 접근 방법, 상태)에 대해 어떠한 가정을 하면 안된다.

## 상호 배제 방법
상호 배제, 세마포어, 모니터, 하드웨어 명령어 방법으로 상호 배제와 임계 영역, 동기화 문제를 해결할 수 있다. 
### 상호 배제(Mutex)
- 소프트웨어적인 임계영역 문제 해결이라고도 불린다.
- 특별한 하드웨어 명령어를 필요로 하지 않는 해결책이다.
  - entry, exit code 작성
- 공유 자원이나 임계 영역에 접근하려면 Key를 가진 프로세스나 스레드만 가능하다.
- 바쁜 대기(busy-waiting)로 프로세서 시간이 낭비된다.
  - 바쁜 대기(busy waiting): 어떤 조건을기다리는 프로세스들이 비생산적으로 자원을 소비하는 대기 루프에 있는 상태
- 데커 알고리즘, 피터슨 알고리즘, 햄포트의 베이커리 알고리즘, 크누스 알고리즘, 핸슨 알고리즘, 다익스트라 알고리즘 등이 있다.

#### 데커(Dekker) 알고리즘
- 두 프로세스의 임계영역 문제를 하드웨어 도움 없이 순순하게 소프트웨어적으로 해결하는 방법이다.
- 임계영역 문제 해결책의 조건을 만족한다.
- 구현
  - 프로세스가 P0, P1일 때 공유변수 flag, turn을 가진다.
  - flag[0]: P0가 임계 영역 진입 flag[1]: P1이 임계 영역 진입
  - turn: 정수형 변수로 값이 0인 경우 P0에게 진입 우선권, 1인 경우 P1에게 진입 우선권을 부여한다.

#### 피터슨(peterson) 알고리즘
- 데커 알고리즘과 비슷하지만 상대적으로 피터슨 알고리즘이 간단하다.
- turn에 동시 접근 문제가 발생하지 않는다.
- 순차적으로 실행된다. 

### 하드웨어 명령어
- 특수한 하드웨어 명령어를 제공하는 경우, 순수한 소프트웨어적인 방법보다 임계 영역 문제를 해결하는 알고리즘이 간단해진다.
- 임계 영역 문제를 해결에 사용할 수 있는 하드웨어 명령어는 2가지이다.
  - TestAndSet: 내용을 검사 및 수정하는 명령어
  - Swap: 두 내용을 서로 바꾸는 명령어
- 하드웨어 명령어를 제공하지 않는 시스템에서는 사용할 수 없다.

#### TestAndSet(TAS)
- 수행하는 작업이 복잡하다.
- 다음과 같은 원자적 연산(atomic operation)을 수행한다.
  - 원자적 연산: 중간에 인터럽트가 발생하지 않고 단번에 수행하는 최소 단위의 기계어 명령어

- 프로세스가 2개인 경우 TAS

  
  - 단일 프로세서 뿐 아니라 메모리를 공유하는 다중 처리 환경에도 적용이 가능하다.
  - 임계 영역에 진입하는 프로세스에 바쁜 대기가 발생한다.
  - 프로세스가 2개 초과인 경우 일부는 무기한 연기에 빠질 수 있다.

- 여러 프로세스의 TAS

### 세마포어(Semaphore)
### 모니터(Monitor)

> ⬆️:[Top](#상호-배제Mutex-Mutual-Exclusion)
> ⬅️:[Back](https://github.com/Minho979/CS_Study/blob/main/README.md#%EF%B8%8F-Operating-System)
> 💁:[Home](https://github.com/Minho979/CS_Study/blob/main/README.md)
> - Reference
> - [구현회. 운영체제-그림으로 배우는 구조와 원리, 개정3판. 한빛아카데미]
